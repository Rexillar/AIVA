name: Gatekeeper (CI)

on:
  pull_request:
    branches: [ "main", "dev" ]
  push:
    branches: [ "main", "dev" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ------------------------------------------------------------------
  # Policy Enforcement
  # ------------------------------------------------------------------
  policy-check:
    name: Repo Policy Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Scan for Exposed Secrets
        run: |
          if find . -name ".env*" -not -path "*/node_modules/*" -not -name ".env.example" -not -name ".env.docker" | grep .; then
            echo "::error::Detected .env files in the repository. Please remove them and add to .gitignore."
            exit 1
          fi

      - name: Check for Forbidden Artifacts
        run: |
          if git ls-files | grep -E "(dist/|build/|node_modules/)"; then
             echo "::error::Build artifacts or node_modules found in git index. Please remove them."
             exit 1
          fi

  # ------------------------------------------------------------------
  # Docker Build Integrity (Smoke Test)
  # ------------------------------------------------------------------
  build-check:
    name: Docker Build Check
    runs-on: ubuntu-latest
    needs: policy-check
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Create Dummy Secrets (Build Requirement)
        run: |
           touch server/.env.secret
           echo "SERVICE_KEY=dummy" > server/.env.secret

      - name: Build Images (No Push)
        # This confirms that "What is in GitHub CAN become a Docker image"
        run: docker compose -f launcher/docker-compose.yml build
